# -----------------------------------------------------
# å–µå–µå®æˆ˜å®¤ï¼šAgentç»„è£…è½¦é—´ (main_with_memory.py)
# -----------------------------------------------------

import os
from langchain_classic.agents import AgentExecutor, create_react_agent
from langchain_core.prompts import PromptTemplate
from langchain_core.tools import Tool
from langchain_openai import ChatOpenAI

from agent_tools import (
    get_realtime_weather, 
    get_stock_realtime_price,
    read_file,
    write_file,
    execute_python_code,
    write_file_wrapper
)


# ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
# æ­¥éª¤1ï¼šå¯¼å…¥â€œè®°å¿†â€å’Œâ€œæ¶ˆæ¯â€ç›¸å…³çš„æ–°æ¨¡å—
# ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
from langchain_core.messages import HumanMessage, AIMessage
from langchain_community.chat_message_histories.in_memory import ChatMessageHistory




# -----------------------------------------------------
# æ ¸å¿ƒè®¾ç½®
# -----------------------------------------------------

# è®¾ç½®ä½ çš„API Keys (å¼ºçƒˆæ¨èä½¿ç”¨ç¯å¢ƒå˜é‡)
# ç¡®ä¿ä½ å·²ç»è®¾ç½®äº† OPENAI_API_KEY, HEFENG_API_KEY, TUSHARE_TOKEN
os.environ["OPENAI_API_KEY"] = "ä½ çš„OpenAI APIå¯†é’¥"
os.environ["OPENAI_API_BASE"] = "https://apikfm.com/v1" # è¿™é‡Œä½¿ç”¨æˆ‘ä»¬è‡ªå·±çš„APIï¼Œå¼€å‘å–µAPI 
# ...ç­‰ç­‰


# -----------------------------------------------------
# æ­¥éª¤2ï¼šåˆå§‹åŒ–â€œå¤§è„‘â€ (LLM)(ä¸ä¸Šä¸€æœŸç›¸åŒ) 
# -----------------------------------------------------
print("[1/5] æ­£åœ¨åˆå§‹åŒ–å¤§æ¨¡å‹ 'å¤§è„‘'...")
# æˆ‘ä»¬é€‰ç”¨gpt-4oï¼Œä½ ä¹Ÿå¯ä»¥æ¢æˆMoonshotæˆ–OpenAI
llm = ChatOpenAI(
    model="gpt-4o",
    temperature=0.1, # Agentæ‰§è¡Œä»»åŠ¡ï¼Œæ¸©åº¦è°ƒä½ï¼Œç¡®ä¿ç¨³å®šæ€§
)

# -----------------------------------------------------
# æ­¥éª¤3ï¼šå°†Pythonå‡½æ•°â€œå°è£…â€æˆAgentèƒ½ç”¨çš„Tool(ä¸ä¸Šä¸€æœŸç›¸åŒ) 
# -----------------------------------------------------
print("[2/5] æ­£åœ¨å°è£…å·¥å…· 'åŒæ‰‹'...")

# å…³é”®ï¼šæˆ‘ä»¬å°†Pythonå‡½æ•° + è¯¦ç»†çš„docstringæè¿°ï¼Œä¸€èµ·æ‰“åŒ…æˆToolå¯¹è±¡
# Agentçš„â€œå¤§è„‘â€åªä¼šå»è¯» 'description' é‡Œçš„å†…å®¹æ¥å†³å®šç”¨å“ªä¸ªå·¥å…·ï¼
tools = [
    Tool(
        name="QueryWeather",
        func=get_realtime_weather,
        description="""æŸ¥è¯¢æŒ‡å®šåŸå¸‚çš„å®æ—¶å¤©æ°”ä¿¡æ¯ã€‚
                   å‚æ•°: city_name (str): å¿…é¡»æ˜¯æ ‡å‡†çš„ä¸­æ–‡åŸå¸‚åç§°ï¼Œä¾‹å¦‚ 'åŒ—äº¬', 'ä¸Šæµ·', 'æ·±åœ³å¸‚'ã€‚
                   è¿”å›: str: åŒ…å«å¤©æ°”ã€æ¸©åº¦ã€é£å‘çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ã€‚"""
    ),
    Tool(
        name="QueryStockPrice",
        func=get_stock_realtime_price,
        description="""æŸ¥è¯¢æŒ‡å®šè‚¡ç¥¨ä»£ç çš„æœ€æ–°å®æ—¶è¡Œæƒ…ä»·æ ¼ã€‚
                   å‚æ•°: stock_code (str): å¿…é¡»æ˜¯Tushareæ ‡å‡†çš„è‚¡ç¥¨ä»£ç , æ ¼å¼ä¸º 'XXXXXX.SZ' æˆ– 'XXXXXX.SH'ã€‚
                   ä¾‹å¦‚: '000001.SZ' (å¹³å®‰é“¶è¡Œ), '600519.SH' (è´µå·èŒ…å°)ã€‚"""
    ),
    Tool(
        name="ReadFile",
        func=read_file,
        description="""è¯»å–æŒ‡å®šè·¯å¾„çš„æ–‡æœ¬æ–‡ä»¶å†…å®¹ã€‚
                   å‚æ•°: file_path (str): è¦è¯»å–çš„æ–‡ä»¶çš„å®Œæ•´è·¯å¾„ã€‚"""
    ),
    Tool(
        name="WriteFile",
        func=write_file_wrapper,
        description="""å°†æŒ‡å®šçš„æ–‡æœ¬å†…å®¹å†™å…¥åˆ°æŒ‡å®šè·¯å¾„çš„æ–‡ä»¶ä¸­ã€‚
                   å¦‚æœæ–‡ä»¶å·²å­˜åœ¨ï¼Œå®ƒå°†è¢«è¦†ç›–ã€‚
                   å‚æ•°: å¿…é¡»æ˜¯ä¸€ä¸ªJSONæ ¼å¼çš„å­—ç¬¦ä¸²ã€‚
                   JSONæ ¼å¼: {{"file_path": "è¦å†™å…¥çš„æ–‡ä»¶çš„å®Œæ•´è·¯å¾„", "content": "è¦å†™å…¥æ–‡ä»¶çš„æ–‡æœ¬å†…å®¹"}}"""
    ),
    Tool(
        name="ExecutePythonCode",
        func=execute_python_code,
        description="""åœ¨æœ¬åœ°çš„Pythonç¯å¢ƒä¸­æ‰§è¡Œä¸€æ®µPythonä»£ç å­—ç¬¦ä¸²ã€‚
                   è­¦å‘Šï¼šè¿™æ˜¯ä¸€ä¸ªé«˜é£é™©å·¥å…·ï¼
                   å‚æ•°: code (str): è¦æ‰§è¡Œçš„Pythonä»£ç å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚: "print(1 + 1)"
                   è¿”å›: str: åŒ…å«ä»£ç çš„æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯ã€‚"""
    )
]

# å°†æ‰€æœ‰å·¥å…·çš„åç§°æå–å‡ºæ¥ï¼Œæ–¹ä¾¿åé¢æç¤ºè¯ä½¿ç”¨
tool_names = ", ".join([tool.name for tool in tools])

# -----------------------------------------------------
# æ­¥éª¤4ï¼šåˆ›å»º ReAct æç¤ºè¯æ¨¡æ¿ (Agentçš„â€œè¡ŒåŠ¨çº²é¢†â€)
# -----------------------------------------------------
print("[3/5] æ­£åœ¨åŠ è½½ ReAct æ€è€ƒæ¡†æ¶(åŠ å…¥è®°å¿†)...")

# è¿™æ®µæç¤ºè¯æ˜¯LangChainæä¾›çš„æ ‡å‡†ReActæ¨¡æ¿
# å®ƒå‘Šè¯‰Agentå¦‚ä½•æ€è€ƒã€å¦‚ä½•ä½¿ç”¨å·¥å…·ã€å¦‚ä½•ç»™å‡ºæœ€ç»ˆç­”æ¡ˆ
# æˆ‘ä»¬ä»Hubä¸Šæ‹‰å–ä¸€ä¸ªä¸­æ–‡ä¼˜åŒ–è¿‡çš„æ¨¡æ¿ï¼ˆå¦‚æœéœ€è¦ï¼Œæˆ–ä½¿ç”¨é»˜è®¤è‹±æ–‡æ¨¡æ¿ï¼‰
# ï¼ï¼ï¼æ³¨æ„çœ‹ï¼Œå®ƒæ¯”ä¸Šä¸€æœŸçš„æ¨¡æ¿å¤šäº† {chat_history} å˜é‡ï¼ï¼ï¼
# ç®€åŒ–çš„æ¨¡æ¿ç¤ºæ„ï¼š
react_prompt_template = """
å›ç­”ä»¥ä¸‹é—®é¢˜ï¼Œå°½ä½ æ‰€èƒ½ã€‚ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å·¥å…·ï¼š

{tools}

ä½¿ç”¨ä»¥ä¸‹æ ¼å¼ï¼š

Question: ä½ å¿…é¡»å›ç­”çš„è¾“å…¥é—®é¢˜
Thought: ä½ åº”è¯¥æ—¶åˆ»æ€è€ƒè¯¥åšä»€ä¹ˆ
Action: é‡‡å–çš„è¡ŒåŠ¨ï¼Œå¿…é¡»æ˜¯[{tool_names}]ä¸­çš„ä¸€ä¸ª
Action Input: ä½ çš„è¡ŒåŠ¨è¾“å…¥
    *** é‡è¦è§„åˆ™ ***
    1. å¦‚æœå·¥å…·çš„æè¿°ä¸­åŒ…å« "Input schema" (è¾“å…¥ schema)ï¼Œä½ çš„ 'Action Input' **å¿…é¡»**æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„ã€å•è¡Œçš„ JSON å¯¹è±¡å­—ç¬¦ä¸²ï¼Œå…¶é”®å’Œå€¼å¿…é¡»åŒ¹é…è¯¥ schemaã€‚
       ä¾‹å¦‚: {{"file_path": "some/path.txt", "content": "è¦å†™å…¥çš„å†…å®¹"}}
    2. å¦‚æœå·¥å…·çš„æè¿°ä¸­æ²¡æœ‰ "Input schema" (ä¾‹å¦‚å®ƒåªéœ€è¦ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²ï¼Œåƒ QueryWeather)ï¼Œåˆ™ 'Action Input' åº”è¯¥åªæ˜¯é‚£ä¸ªå­—ç¬¦ä¸²å€¼ã€‚
       ä¾‹å¦‚: ä¸Šæµ·
    *****************
Observation: ä½ çš„è¡ŒåŠ¨ç»“æœ
... (è¿™ä¸ª Thought/Action/Action Input/Observation çš„è¿‡ç¨‹å¯ä»¥é‡å¤Næ¬¡)
Thought: æˆ‘ç°åœ¨çŸ¥é“æœ€ç»ˆç­”æ¡ˆäº†
Final Answer: åŸå§‹è¾“å…¥é—®é¢˜çš„æœ€ç»ˆç­”æ¡ˆ

å¼€å§‹ï¼

**é‡è¦çš„æ˜¯ï¼Œåœ¨ä½ çš„â€œThoughtâ€ä¸­ï¼Œè¦æ—¶åˆ»å‚è€ƒä¹‹å‰çš„èŠå¤©è®°å½•ã€‚**

**ä¹‹å‰çš„èŠå¤©è®°å½•:**
{chat_history}

**æ–°çš„ç”¨æˆ·è¾“å…¥:**
Question: {input}
Thought:{agent_scratchpad}
"""

# å°†æ¨¡æ¿å­—ç¬¦ä¸²è½¬æ¢ä¸ºLangChainçš„PromptTemplateå¯¹è±¡
prompt = PromptTemplate.from_template(react_prompt_template)

# -----------------------------------------------------
# æ­¥éª¤5ï¼šåˆ›å»ºAgentæ‰§è¡Œå™¨ (ä¸ä¸Šä¸€æœŸç›¸åŒ)
# -----------------------------------------------------
print("[4/5] æ­£åœ¨ç»„è£…Agentæ‰§è¡Œå™¨...")

# "create_react_agent" è´Ÿè´£å°† å¤§è„‘(llm) å’Œ æç¤ºè¯(prompt) ç»‘å®šåœ¨ä¸€èµ·
agent = create_react_agent(llm=llm, tools=tools, prompt=prompt)

# "AgentExecutor" æ˜¯Agentçš„â€œå¿ƒè·³â€ï¼Œå®ƒè´Ÿè´£è¿è¡Œæ•´ä¸ª ReAct å¾ªç¯
# verbose=True è®©æˆ‘ä»¬èƒ½çœ‹åˆ°Agentçš„å®Œæ•´æ€è€ƒè¿‡ç¨‹ï¼
agent_executor = AgentExecutor(
    agent=agent, 
    tools=tools, 
    verbose=True, # ï¼ï¼ï¼ï¼ï¼ï¼ä¸€å®šè¦æ‰“å¼€ï¼Œçœ‹â€œå¿ƒè·¯å†ç¨‹â€
    handle_parsing_errors=True # å¤„ç†å¯èƒ½çš„è¾“å‡ºæ ¼å¼é”™è¯¯
)

# -----------------------------------------------------
# æ­¥éª¤6ï¼šï¼ï¼ï¼åˆ›å»ºâ€œè®°å¿†èŠ¯ç‰‡â€å’Œâ€œå¯¹è¯å¾ªç¯â€ï¼ï¼ï¼
# -----------------------------------------------------
print("[5/5] æ­£åœ¨åˆ›å»º 'çŸ­æœŸè®°å¿†èŠ¯ç‰‡'...")

# åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆå§‹åŒ–ä¸€ä¸ªç©ºçš„èŠå¤©è®°å½•å¯¹è±¡
# ChatMessageHistory æ˜¯ä¸€ä¸ªç®€å•çš„å†…å­˜ä¸­å­˜å‚¨
chat_history = ChatMessageHistory()

print("\n--- å…·å¤‡è®°å¿†çš„Agent å·²å¯åŠ¨ï¼Œè¯·è¾“å…¥ä½ çš„é—®é¢˜ ---")
print("--- (è¾“å…¥ 'é€€å‡º' æ¥ç»“æŸå¯¹è¯) ---")

# -----------------------------------------------------
# æ­¥éª¤6ï¼šè§è¯å¥‡è¿¹çš„æ—¶åˆ»ï¼
# -----------------------------------------------------

print("\n--- Agent å·²å¯åŠ¨ï¼Œå‡†å¤‡æ¥æ”¶ä»»åŠ¡ ---")

# æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªwhileå¾ªç¯ï¼Œæ¥æ¨¡æ‹Ÿä¸€ä¸ªæŒç»­çš„å¯¹è¯
while True:
    try:
        # 1. è·å–ç”¨æˆ·è¾“å…¥
        user_input = input("ğŸ‘¤ ä½ ï¼š")
        if user_input.lower() in ["é€€å‡º", "exit", "quit"]:
            print("ğŸ¤– Agent: æ‹œæ‹œï¼ä¸‹æ¬¡å†èŠï¼")
            break

        # 2. ï¼ï¼ï¼è°ƒç”¨Agentæ‰§è¡Œå™¨ï¼ï¼ï¼
        # å…³é”®ï¼šæˆ‘ä»¬æŠŠâ€œå†å²è®°å½•â€å’Œâ€œæ–°è¾“å…¥â€ä¸€èµ·ä¼ è¿›å»
        result = agent_executor.invoke({
            "input": user_input,
            "chat_history": chat_history.messages # ä¼ å…¥å®Œæ•´çš„å†å²æ¶ˆæ¯åˆ—è¡¨
        })
        
        # 3. æ‰“å°AIçš„å›ç­”
        ai_output = result['output']
        print(f"ğŸ¤– Agent: {ai_output}")

        # 4. ï¼ï¼ï¼æ‰‹åŠ¨æ›´æ–°â€œè®°å¿†èŠ¯ç‰‡â€ï¼ï¼ï¼
        # æˆ‘ä»¬æŠŠåˆšæ‰çš„é—®ç­”ï¼Œå­˜å…¥å†å²è®°å½•ä¸­ï¼Œä¸ºä¸‹ä¸€è½®åšå‡†å¤‡
        chat_history.add_user_message(HumanMessage(content=user_input))
        chat_history.add_ai_message(AIMessage(content=ai_output))

    except Exception as e:
        print(f"\n--- Agent è¿è¡Œå‡ºé”™ ---")
        print(e)
        # å³ä½¿å‡ºé”™ï¼Œä¹Ÿå°è¯•ç»§ç»­å¾ªç¯